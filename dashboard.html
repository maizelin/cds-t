<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APP2 | é†«å¸«ç«¯è‡¨åºŠæ±ºç­–ç³»çµ± (SMART Enabled)</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-dark: #2c3e50; --accent: #3498db; --bg: #f0f2f5; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        
        .sidebar { width: 280px; background: var(--primary-dark); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: #1a252f; text-align: center; }
        .patient-info-box { padding: 20px; border-bottom: 1px solid #3e4f5f; }
        
        .content { flex: 1; padding: 25px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        
        .action-header { border-left: 5px solid var(--accent); padding-left: 10px; margin-bottom: 15px; color: var(--primary-dark); }
        #sync-loader { color: var(--accent); font-weight: bold; }
        .risk-badge { padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-weight: bold; }
        
        .btn-submit { background: var(--success); color: white; border: none; padding: 15px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 15px; }
        textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-top: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h3>SMART è‡¨åºŠç³»çµ±</h3>
    </div>
    <div class="patient-info-box">
        <p style="opacity: 0.7; font-size: 0.8em; margin-bottom: 5px;">ç•¶å‰é¸å®šç—…æ‚£</p>
        <h2 id="patient-name" style="margin: 0; font-size: 1.4em;">è¼‰å…¥ä¸­...</h2>
        <p id="patient-details" style="font-size: 0.9em; margin-top: 10px;"></p>
    </div>
    <div style="padding: 20px; font-size: 0.8em; color: #95a5a6;">
        <p>ç³»çµ±ç‹€æ…‹: <span id="auth-status">é©—è­‰ä¸­...</span></p>
    </div>
</div>

<div class="content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h2 style="margin:0">é è·æ•¸æ“šè¶¨å‹¢ç›£æ§</h2>
        <div id="sync-loader">ğŸ”„ FHIR æ•¸æ“šåŒæ­¥ä¸­...</div>
    </div>

    <div class="dashboard-grid">
        <div class="left-col">
            <div class="card">
                <h3 class="action-header">è¡€å£“ç›£æ§è¶¨å‹¢ (SBP/DBP)</h3>
                <canvas id="bpChart" height="140"></canvas>
            </div>
            <div class="card">
                <h3 class="action-header">è¡€ç³–ç›£æ§è¶¨å‹¢ (mg/dL)</h3>
                <canvas id="bgChart" height="140"></canvas>
            </div>
        </div>

        <div class="right-col">
            <div class="card">
                <h3 class="action-header">è‡¨åºŠæ±ºç­–è¼”åŠ© (CDSS)</h3>
                <div id="risk-info" class="risk-badge" style="background: #e9ecef;">åˆ†ææ•¸æ“šä¸­...</div>
                
                <p><strong>ğŸ©º é†«ç™‚è™•ç½®å»ºè­°ï¼š</strong></p>
                <div style="margin: 10px 0;"><input type="checkbox"> å»ºè­°å•Ÿå‹•ä½éˆ‰é£²é£Ÿè¨ˆç•«</div>
                <div style="margin: 10px 0;"><input type="checkbox"> å®‰æ’ 24 å°æ™‚è¡€å£“ç›£æ¸¬ (ABPM)</div>
                
                <p style="margin-top:20px;"><strong>ğŸ’Š è—¥ç‰©èª¿æ•´ (Medication Request)ï¼š</strong></p>
                <select id="med-select">
                    <option>ç¶­æŒç¾æœ‰è—¥ç‰©åŠ‘é‡</option>
                    <option>Valsartan 80mg -> 160mg (æ¯æ—¥ä¸€æ¬¡)</option>
                    <option>Metformin 500mg (æ¯æ—¥äºŒæ¬¡)</option>
                </select>
                
                <p style="margin-top:20px;"><strong>ğŸ“ é†«å¸«å‚™è¨»ï¼š</strong></p>
                <textarea id="dr-note" placeholder="è«‹è¼¸å…¥è‡¨åºŠå»ºè­°..."></textarea>
                
                <button class="btn-submit" onclick="submitDecision()">ç¢ºèªä¸¦å›å‚³é†«å›‘è‡³ HIS</button>
            </div>
        </div>
    </div>
</div>

<script>
    let bpChart, bgChart;
    let smartClient;

    // åˆå§‹åŒ–åœ–è¡¨
    function initCharts() {
        const bpCtx = document.getElementById('bpChart').getContext('2d');
        bpChart = new Chart(bpCtx, {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'æ”¶ç¸®å£“', data: [], borderColor: '#e74c3c', tension: 0.3, fill: false },
                { label: 'èˆ’å¼µå£“', data: [], borderColor: '#3498db', tension: 0.3, fill: false }
            ]}
        });

        const bgCtx = document.getElementById('bgChart').getContext('2d');
        bgChart = new Chart(bgCtx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'è¡€ç³–å€¼', data: [], backgroundColor: '#f1c40f' }] }
        });
    }

    // SMART å•Ÿå‹•èˆ‡æ•¸æ“šæŠ“å–
    async function startApp() {
        initCharts();
        try {
            // é—œéµï¼šèˆ‡ launch.html æ¥æ£’
            smartClient = await FHIR.oauth2.ready();
            document.getElementById('auth-status').innerText = "âœ… å·²é€šéå®‰å…¨æˆæ¬Š";
            
            // 1. æŠ“å–ç—…æ‚£åŸºæœ¬è³‡æ–™
            const patient = await smartClient.patient.read();
            const name = patient.name ? patient.name[0].text || (patient.name[0].family + patient.name[0].given.join(' ')) : "åŒ¿åç—…æ‚£";
            document.getElementById('patient-name').innerText = name;
            document.getElementById('patient-details').innerText = `æ€§åˆ¥: ${patient.gender} | ç”Ÿæ—¥: ${patient.birthDate}`;

            // 2. æŠ“å–é‡æ¸¬æ•¸æ“š
            fetchFHIRData(smartClient.patient.id);

        } catch (e) {
            console.warn("æœªåµæ¸¬åˆ° SMART ç’°å¢ƒï¼Œé€²å…¥ Demo æ¨¡å¼");
            document.getElementById('auth-status').innerText = "âš ï¸ Demo æ¨¡å¼ (ç„¡ Token)";
            document.getElementById('patient-name').innerText = "é™³å˜‰æ˜ (æ¸¬è©¦)";
            fetchFHIRData("DEMO-PATIENT-01"); // ä½¿ç”¨æ‚¨ä¹‹å‰ä¸Šå‚³çš„ ID
        }
    }

    async function fetchFHIRData(pid) {
        document.getElementById('sync-loader').style.display = 'block';
        const serverUrl = "https://thas.mohw.gov.tw/v/r4/fhir"; // æˆ–ä½¿ç”¨ smartClient.state.serverUrl
        
        try {
            const resp = await fetch(`${serverUrl}/Observation?subject=Patient/${pid}&_sort=date&_count=30`);
            const bundle = await resp.json();
            processData(bundle.entry || []);
            document.getElementById('sync-loader').style.display = 'none';
        } catch (err) {
            console.error("æ•¸æ“šæŠ“å–å¤±æ•—", err);
        }
    }

    function processData(entries) {
        const bpLabels = [], sbp = [], dbp = [], bgLabels = [], bg = [];
        
        entries.forEach(item => {
            const r = item.resource;
            const date = new Date(r.effectiveDateTime).toLocaleDateString();
            if (r.code.coding[0].code === "85354-9") {
                bpLabels.push(date);
                sbp.push(r.component[0].valueQuantity.value);
                dbp.push(r.component[1].valueQuantity.value);
            } else if (r.code.coding[0].code === "2339-0") {
                bgLabels.push(date);
                bg.push(r.valueQuantity.value);
            }
        });

        bpChart.data.labels = bpLabels;
        bpChart.data.datasets[0].data = sbp;
        bpChart.data.datasets[1].data = dbp;
        bpChart.update();

        bgChart.data.labels = bgLabels;
        bgChart.data.datasets[0].data = bg;
        bgChart.update();

        // æ±ºç­–åˆ†æ
        const risk = document.getElementById('risk-info');
        if (sbp.length > 0 && sbp[sbp.length-1] > 140) {
            risk.innerHTML = "ğŸš¨ é«˜è¡€å£“é¢¨éšª (SBP > 140)";
            risk.style.background = "#fee2e2"; risk.style.color = "#b91c1c";
        } else {
            risk.innerHTML = "âœ… ç”Ÿç†ç‹€æ…‹ç©©å®š";
            risk.style.background = "#dcfce7"; risk.style.color = "#15803d";
        }
    }

    function submitDecision() {
        const med = document.getElementById('med-select').value;
        const note = document.getElementById('dr-note').value;
        alert(`é†«å›‘å·²ç”Ÿæˆï¼\n\nè™•æ–¹ä¿®æ­£ï¼š${med}\né†«å¸«è¨»è¨˜ï¼š${note}\n\næ•¸æ“šå·²å°è£ç‚º FHIR MedicationRequest æ ¼å¼å­˜æª”ã€‚`);
    }

    window.onload = startApp;
</script>
</body>
</html>