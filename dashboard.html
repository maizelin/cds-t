<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>APP2 | è‡¨åºŠæ±ºç­–æ”¯æŒå„€è¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-dark: #2c3e50; --accent: #3498db; --bg: #f0f2f5; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: var(--primary-dark); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: #1a252f; text-align: center; border-bottom: 1px solid #34495e; }
        .patient-list { flex: 1; overflow-y: auto; padding: 10px; }
        .patient-item { padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .patient-item.active { background: var(--accent); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px; }
        .cdss-badge { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 15px; }
        .status-normal { background: #dcfce7; color: #15803d; }
        .status-danger { background: #fee2e2; color: #b91c1c; }
        .btn-submit { background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        select, textarea { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header"><h3>è‡¨åºŠç›£æ§æ¸…å–®</h3></div>
    <div class="patient-list" id="p-list">
        <div class="patient-item active" onclick="selectPatient('2892', 'Marquardt', this)">Marquardt <span id="dot-2892" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('4117', 'Pulido', this)">Pulido <span id="dot-4117" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('4679', 'Armstrong', this)">Armstrong <span id="dot-4679" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('4836', 'Carter', this)">Carter <span id="dot-4836" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('4896', 'Klocko', this)">Klocko <span id="dot-4896" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('4969', 'Atencio', this)">Atencio <span id="dot-4969" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('6295', 'Considine', this)">Considine <span id="dot-6295" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('6377', 'Riojas', this)">Riojas <span id="dot-6377" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('7241', 'Senger', this)">Senger <span id="dot-7241" class="status-dot"></span></div>
        <div class="patient-item" onclick="selectPatient('7530', 'Rice', this)">Rice <span id="dot-7530" class="status-dot"></span></div>
    </div>
</div>

<div class="content">
    <h2 id="view-title">ç—…æ‚£ç›£æ§ï¼šMarquardt</h2>
    <div class="dashboard-grid">
        <div class="left-col">
            <div class="card"><canvas id="bpChart" height="150"></canvas></div>
            <div class="card"><canvas id="bgChart" height="150"></canvas></div>
        </div>
        <div class="right-col">
            <div class="card">
                <h3>è‡¨åºŠæ±ºç­–æ”¯æŒ (CDSS)</h3>
                <div id="risk-info" class="cdss-badge">ç­‰å¾…åŒæ­¥...</div>
                <p><strong>è‡¨åºŠå»ºè­°ï¼š</strong></p>
                <div style="margin:10px 0;"><input type="checkbox"> å»ºè­°èª¿æ•´ç”¨è—¥åŠ‘é‡</div>
                <div style="margin:10px 0;"><input type="checkbox"> å®‰æ’ä¸‹é€±è¿½è¹¤</div>
                <select id="med-action">
                    <option>ç¶­æŒç¾æœ‰æ²»ç™‚</option>
                    <option>èª¿å‡é™å£“è—¥åŠ‘é‡</option>
                    <option>å•Ÿå‹•è¡€ç³–ç®¡ç†è¨ˆç•«</option>
                </select>
                <textarea placeholder="é†«å¸«è‡¨åºŠå‚™è¨»..."></textarea>
                <button class="btn-submit" onclick="alert('æ±ºç­–å·²å­˜å…¥ç³»çµ±')">ç¢ºèªæ±ºç­–</button>
            </div>
        </div>
    </div>
</div>

<script>
    let bpChart, bgChart;
    let currentPID = '2892';
    const serverURL = "https://thas.mohw.gov.tw/v/r4/fhir";

    function initCharts() {
        const bpCtx = document.getElementById('bpChart').getContext('2d');
        bpChart = new Chart(bpCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'SBP', data: [], borderColor: '#e74c3c' }, { label: 'DBP', data: [], borderColor: '#3498db' }] } });
        const bgCtx = document.getElementById('bgChart').getContext('2d');
        bgChart = new Chart(bgCtx, { type: 'bar', data: { labels: [], datasets: [{ label: 'Glucose', data: [], backgroundColor: '#f1c40f' }] } });
    }

    async function fetchData() {
        try {
            const resp = await fetch(`${serverURL}/Observation?subject=Patient/${currentPID}&_sort=-date&_count=10`);
            const bundle = await resp.json();
            updateDashboard(bundle.entry || []);
        } catch (e) { console.error("åŒæ­¥å¤±æ•—"); }
    }

    function updateDashboard(entries) {
        const labels = [], sbp = [], dbp = [], bg = [];
        entries.forEach(item => {
            const r = item.resource;
            const date = new Date(r.effectiveDateTime).toLocaleTimeString();
            if (r.code.coding[0].code === "85354-9") {
                labels.push(date); sbp.push(r.component[0].valueQuantity.value); dbp.push(r.component[1].valueQuantity.value);
            } else if (r.code.coding[0].code === "2339-0") {
                bg.push(r.valueQuantity.value);
            }
        });
        bpChart.data.labels = labels; bpChart.data.datasets[0].data = sbp; bpChart.data.datasets[1].data = dbp; bpChart.update();
        bgChart.data.datasets[0].data = bg; bgChart.update();

        const risk = document.getElementById('risk-info');
        if (sbp[0] >= 140) { risk.innerText = "ğŸš¨ è­¦è¨Šï¼šStage 2 é«˜è¡€å£“"; risk.className = "cdss-badge status-danger"; document.getElementById(`dot-${currentPID}`).style.background = "#e74c3c"; }
        else { risk.innerText = "âœ… ç”Ÿç†ç‹€æ…‹ç©©å®š"; risk.className = "cdss-badge status-normal"; document.getElementById(`dot-${currentPID}`).style.background = "#2ecc71"; }
    }

    function selectPatient(pid, name, el) {
        currentPID = pid; document.getElementById('view-title').innerText = `ç—…æ‚£ç›£æ§ï¼š${name}`;
        document.querySelectorAll('.patient-item').forEach(i => i.classList.remove('active')); el.classList.add('active');
        fetchData();
    }

    // æ¯ 5 ç§’è‡ªå‹•å³æ™‚é‡æ–°æ•´ç†ï¼Œæ¥æ‡‰ APP 1 çš„ä¸Šå‚³
    setInterval(fetchData, 5000);
    window.onload = () => { initCharts(); fetchData(); };
</script>
</body>
</html>